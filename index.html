<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Scan Prix Produit</title>
  <script src="biblioth√®ques/papaparse.min.js"></script>
  <script src="biblioth√®ques/quagga.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background: #f0f0f0;
    }
    header img {
      max-width: 200px;
      margin-top: 20px;
    }
    h1 {
      font-size: 24px;
      margin: 10px 0;
    }
    #version {
      font-size: 14px;
      color: gray;
      margin-bottom: 5px;
    }
    #ref-count {
      font-size: 14px;
      margin-bottom: 20px;
    }
    #scanner-container {
      display: none;
      position: relative;
      width: 100%;
      height: 60vh;
      background: #000;
    }
    #scanner {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #result {
      margin-top: 20px;
      font-size: 18px;
    }
    .btn {
      padding: 15px 30px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
    }
    .btn-green {
      background-color: #28a745;
      color: white;
    }
    .btn-red {
      background-color: #dc3545;
      color: white;
    }
    .hidden {
      display: none;
    }
    #product-info {
      margin-top: 20px;
      font-size: 16px;
    }
    #not-found {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <header>
    <img src="Logo-le-relais-0.jpg" alt="Logo Le Relais" />
    <h1>Scan Prix Produit</h1>
    <div id="version">Version du code : 1.1</div>
    <div id="ref-count">R√©f√©rences produits : chargement‚Ä¶</div>
  </header>

  <main>
    <button class="btn btn-green" id="start-scan">üì∑ Scanner un Code-barres</button>

    <div id="scanner-container">
      <div id="scanner"></div>
    </div>

    <div id="result" class="hidden">
      Code-barres : <span id="barcode"></span><br>
      <button class="btn btn-green" id="validate-scan">‚úÖ Valider</button>
      <button class="btn btn-red" id="retry-scan">üîÅ Recommencer</button>
    </div>

    <div id="product-info"></div>
  </main>

  <script>
    let barcodeDetected = '';
    let csvData = [];

    // Charger le CSV √† l‚Äôouverture
    Papa.parse("BaseProduits.csv", {
      download: true,
      header: true,
      complete: function(results) {
        csvData = results.data.filter(row => row["Code-barres"]);
        document.getElementById("ref-count").textContent = `R√©f√©rences produits import√©es : ${csvData.length}`;
      }
    });

    function showScanner() {
      document.getElementById("scanner-container").style.display = "block";
      document.getElementById("result").classList.add("hidden");
      document.getElementById("product-info").innerHTML = "";

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#scanner'),
          constraints: {
            facingMode: "environment"
          }
        },
        decoder: {
          readers: ["ean_reader"]
        }
      }, function(err) {
        if (err) {
          console.error(err);
          return;
        }
        Quagga.start();
      });

      Quagga.onDetected(data => {
        if (!barcodeDetected) {
          barcodeDetected = data.codeResult.code;
          document.getElementById("barcode").textContent = barcodeDetected;
          document.getElementById("result").classList.remove("hidden");
          Quagga.stop();
        }
      });
    }

    document.getElementById("start-scan").addEventListener("click", () => {
      barcodeDetected = '';
      showScanner();
    });

    document.getElementById("retry-scan").addEventListener("click", () => {
      barcodeDetected = '';
      showScanner();
    });

    document.getElementById("validate-scan").addEventListener("click", () => {
      let product = csvData.find(row => row["Code-barres"] === barcodeDetected);
      if (product) {
        document.getElementById("product-info").innerHTML = `
          <div><strong>Nom :</strong> ${product["Produits"]}</div>
          <div><strong>Quantit√© :</strong> ${product["Quantit√©"]}</div>
          <div><strong>Prix :</strong> ${product["Prix"]}</div>
        `;
      } else {
        document.getElementById("product-info").innerHTML = `
          <div><strong>Code-barres :</strong> ${barcodeDetected}</div>
          <div id="not-found">Produit Introuvable</div>
        `;
      }
      document.getElementById("scanner-container").style.display = "none";
      document.getElementById("result").classList.add("hidden");
    });
  </script>

</body>
</html>
